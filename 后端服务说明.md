# PandaAI 后端服务说明

## 🚀 服务状态

### ✅ 所有服务已正常启动

- **PandaFactor**: `http://127.0.0.1:8111/` ✅
- **QuantFlow**: `http://127.0.0.1:8000/` ✅

---

## 📊 PandaFactor API (端口 8111)

### 聊天相关

#### 1. LLM 状态查询
```http
GET http://127.0.0.1:8111/llm/status
```
返回LLM管理器的状态，包括多密钥状态。

#### 2. 获取可用模型
```http
GET http://127.0.0.1:8111/llm/models
```
返回可用的LLM模型列表（DeepSeek、Qwen等）。

#### 3. 简化聊天接口
```http
POST http://127.0.0.1:8111/llm/chat/simple
Content-Type: application/json

{
  "message": "你好",
  "model": "deepseek",
  "history": []
}
```
不需要 user_id 的简化聊天接口。

#### 4. 完整聊天接口
```http
POST http://127.0.0.1:8111/llm/chat
Content-Type: application/json

{
  "user_id": "user123",
  "message": "你好",
  "session_id": "session456"
}
```
支持用户会话管理的完整聊天接口。

#### 5. 切换模型
```http
POST http://127.0.0.1:8111/llm/switch_model
Content-Type: application/json

{
  "model_type": "deepseek"
}
```
切换当前使用的LLM模型。

#### 6. 聊天会话列表
```http
GET http://127.0.0.1:8111/llm/chat/sessions?user_id=user123&limit=10
```
获取用户的聊天会话列表。

### 数据分析相关

#### 1. 股票技术分析
```http
POST http://127.0.0.1:8111/analysis/stock
Content-Type: application/json

{
  "symbol": "000001",
  "period": 20
}
```
返回股票的技术分析结果。

#### 2. 生成数据图表
```http
POST http://127.0.0.1:8111/analysis/chart
Content-Type: application/json

{
  "data": [...],
  "chart_type": "line",
  "title": "价格走势"
}
```
使用 Matplotlib 生成图表，返回 base64 编码的图片。

#### 3. 因子回测
```http
POST http://127.0.0.1:8111/analysis/factor
Content-Type: application/json

{
  "factor_values": [...],
  "returns": [...]
}
```
执行因子回测分析，返回夏普率、最大回撤等指标。

#### 4. 市场概况
```http
GET http://127.0.0.1:8111/analysis/market_overview
```
获取市场概况数据。

### API 文档
```http
GET http://127.0.0.1:8111/docs
```
Swagger UI 交互式API文档。

---

## 🚀 QuantFlow API (端口 8000)

### 工作流管理

#### 1. 获取所有工作流
```http
GET http://127.0.0.1:8000/api/workflows
```

#### 2. 获取单个工作流
```http
GET http://127.0.0.1:8000/api/workflows/{workflow_id}
```

#### 3. 创建工作流
```http
POST http://127.0.0.1:8000/api/workflows
Content-Type: application/json

{
  "id": "wf_001",
  "name": "我的策略",
  "nodes": [],
  "connections": []
}
```

#### 4. 更新工作流
```http
PUT http://127.0.0.1:8000/api/workflows/{workflow_id}
Content-Type: application/json

{
  "id": "wf_001",
  "name": "更新后的策略",
  "nodes": [],
  "connections": []
}
```

#### 5. 删除工作流
```http
DELETE http://127.0.0.1:8000/api/workflows/{workflow_id}
```

### 工作流执行

#### 1. 执行工作流
```http
POST http://127.0.0.1:8000/api/workflows/{workflow_id}/execute
Content-Type: application/json

{
  "parameters": {}
}
```

#### 2. 获取执行历史
```http
GET http://127.0.0.1:8000/api/executions
```

#### 3. 获取执行详情
```http
GET http://127.0.0.1:8000/api/executions/{execution_id}
```

### 节点库

#### 1. 获取可用节点
```http
GET http://127.0.0.1:8000/api/nodes
```
返回所有可用的工作流节点（数据源、因子计算、ML模型等）。

### 市场数据

#### 1. 市场概况
```http
GET http://127.0.0.1:8000/api/market/overview
```
返回指数数据。

#### 2. 因子列表
```http
GET http://127.0.0.1:8000/api/factors/list
```

### 系统

#### 1. 健康检查
```http
GET http://127.0.0.1:8000/api/health
```

#### 2. WebSocket
```websocket
ws://127.0.0.1:8000/ws
```
实时推送工作流执行状态。

### API 文档
```http
GET http://127.0.0.1:8000/docs
```

---

## 🎨 前端界面

### PandaAI 金融分析平台
```
http://127.0.0.1:8111/
```
**功能**:
- 🤖 AI 对话助手
- 📊 因子分析
- 📈 数据分析
- 🎯 模型切换
- 🚀 快速跳转到 QuantFlow

### QuantFlow 工作流编辑器
```
http://127.0.0.1:8000/quantflow/
```
**功能**:
- 📐 可视化工作流设计
- 🔗 节点拖拽连接
- ▶️  一键执行
- 📊 实时监控

### 超级图表
```
http://127.0.0.1:8000/charts/
```
**功能**:
- 📈 价格走势图
- 📊 成交量图
- 🎯 技术指标图
- 💰 收益曲线图

---

## 🛠️ 服务管理

### 启动服务

#### 方式1: 使用批处理脚本
```bash
# 一键启动所有服务
quick_start.bat

# 或者重启所有服务
restart_all.bat
```

#### 方式2: 手动启动
```bash
# 启动 PandaFactor
cd panda_factor-main\panda_factor-main
py start_complete.py

# 启动 QuantFlow (新终端)
py src\panda_server\main.py
```

#### 方式3: 集成启动
```bash
py start_integrated.py
```

### 测试服务
```bash
py test_backend.py
```
运行完整的后端API测试。

### 停止服务
```bash
# 关闭终端窗口，或按 Ctrl+C
```

---

## 🐛 已修复的问题

### 1. 路由前缀重复
- **现象**: `/llm/status` 返回 404
- **原因**: 路由定义已包含 `/llm/` 前缀，加载时又添加了一次
- **解决**: 移除 `include_router` 的 `prefix` 参数

### 2. /chat/simple 404
- **现象**: `/llm/chat/simple` 返回 404
- **原因**: 路由定义为 `/chat/simple`，缺少 `/llm` 前缀
- **解决**: 统一所有路由路径，添加 `/llm` 前缀

---

## 📝 开发调试

### 查看日志
服务启动后，日志会实时显示在终端窗口。

### 检查端口占用
```bash
# 检查 8111 端口
netstat -ano | findstr :8111

# 检查 8000 端口
netstat -ano | findstr :8000
```

### 清理端口
```bash
# 使用端口管理工具
cd panda_factor-main\panda_factor-main
py port_manager.py
```

---

## 🎯 API 使用示例

### Python 示例

```python
import requests

# 1. 调用 LLM 对话
response = requests.post(
    "http://127.0.0.1:8111/llm/chat/simple",
    json={
        "message": "分析一下000001这只股票",
        "model": "deepseek"
    }
)
print(response.json())

# 2. 创建工作流
workflow = {
    "id": "my_strategy",
    "name": "动量策略",
    "nodes": [
        {
            "id": "node1",
            "type": "data_source",
            "name": "数据加载",
            "position": {"x": 100, "y": 100},
            "data": {"symbol": "000001"}
        }
    ],
    "connections": []
}
response = requests.post(
    "http://127.0.0.1:8000/api/workflows",
    json=workflow
)
print(response.json())

# 3. 获取市场数据
response = requests.get(
    "http://127.0.0.1:8000/api/market/overview"
)
print(response.json())
```

### JavaScript 示例

```javascript
// 1. 调用 LLM 对话
fetch('http://127.0.0.1:8111/llm/chat/simple', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    message: '你好',
    model: 'deepseek'
  })
})
.then(r => r.json())
.then(data => console.log(data));

// 2. 获取工作流列表
fetch('http://127.0.0.1:8000/api/workflows')
  .then(r => r.json())
  .then(workflows => console.log(workflows));

// 3. WebSocket 连接
const ws = new WebSocket('ws://127.0.0.1:8000/ws');
ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  console.log('收到消息:', message);
};
```

---

## ✅ 快速检查清单

- [x] PandaFactor 服务启动 (端口 8111)
- [x] QuantFlow 服务启动 (端口 8000)
- [x] LLM API 正常响应
- [x] 工作流 API 正常响应
- [x] 前端界面可访问
- [x] API 文档可访问
- [x] WebSocket 连接正常

---

**最后更新**: 2026-01-14 17:45  
**状态**: ✅ 所有服务正常运行  
**端口**: 8111 (PandaFactor), 8000 (QuantFlow)
