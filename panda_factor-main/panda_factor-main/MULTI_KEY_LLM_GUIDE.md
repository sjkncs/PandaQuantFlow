# å¤šAPIå¯†é’¥LLMè´Ÿè½½å‡è¡¡é…ç½®æŒ‡å—

## âœ… å·²å®Œæˆé…ç½®

### å¤šå¯†é’¥è´Ÿè½½å‡è¡¡ç³»ç»Ÿ

**é…ç½®æ–‡ä»¶**: `panda_common/panda_common/config.yaml`

```yaml
# LLMé…ç½® - ç¡…åŸºæµåŠ¨APIï¼ˆå¤šå¯†é’¥è´Ÿè½½å‡è¡¡ï¼‰
LLM_API_KEYS:
  - "sk-ljllswzyhlrrskmolcxayvemftjuzrgbiuwnedfnfjckxnpu"  # å¡å¯†1
  - "sk-ridvotghvcwjqormgutcojreigmszrrqhijbezbwhbvhcedw"  # å¡å¯†2
  - "sk-kefpbqtbxodjvubcvoytodjsqtmaodriwtmreialxjbonstr"  # å¡å¯†3

# å¯ç”¨çš„é‡‘èåˆ†ææ¨¡å‹
LLM_MODELS:
  deepseek: "deepseek-ai/DeepSeek-V3"           # ä»£ç åˆ†æã€æŠ€æœ¯æŒ‡æ ‡
  claude: "anthropic/claude-3.5-sonnet"         # æ·±åº¦æ¨ç†ã€ç­–ç•¥åˆ†æ
  kimi: "Pro/moonshotai/Kimi-K2-Thinking"       # é•¿æ–‡æœ¬ã€ç ”æŠ¥åˆ†æ
  qwen: "Qwen/Qwen2.5-72B-Instruct"             # ä¸­æ–‡ç†è§£ã€å¸‚åœºè§£è¯»

# è´Ÿè½½å‡è¡¡ç­–ç•¥
LLM_LOAD_BALANCE_STRATEGY: "round_robin"  # è½®è¯¢ç­–ç•¥
LLM_MAX_RETRIES: 3                        # æ¯ä¸ªå¯†é’¥é‡è¯•3æ¬¡
LLM_RETRY_DELAY: 1                        # é‡è¯•é—´éš”1ç§’
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å¤šå¯†é’¥è½®è¯¢
- âœ… 3ä¸ªAPIå¯†é’¥è‡ªåŠ¨è½®æµä½¿ç”¨
- âœ… å‡è¡¡åˆ†é…è¯·æ±‚è´Ÿè½½
- âœ… é¿å…å•ä¸ªå¯†é’¥é¢åº¦è€—å°½

### 2. è‡ªåŠ¨æ•…éšœè½¬ç§»
- âœ… å•ä¸ªå¯†é’¥å¤±è´¥è‡ªåŠ¨åˆ‡æ¢
- âœ… æ¯ä¸ªå¯†é’¥æ”¯æŒ3æ¬¡é‡è¯•
- âœ… æ‰€æœ‰å¯†é’¥å¤±è´¥æ‰æŠ¥é”™

### 3. æ™ºèƒ½è´Ÿè½½å‡è¡¡
- **è½®è¯¢ç­–ç•¥** (round_robin): ä¾æ¬¡ä½¿ç”¨æ¯ä¸ªå¯†é’¥
- **éšæœºç­–ç•¥** (random): éšæœºé€‰æ‹©å¯†é’¥
- **æ•…éšœè½¬ç§»** (failover): ä¼˜å…ˆä½¿ç”¨æˆåŠŸç‡é«˜çš„å¯†é’¥

### 4. å››å¤§é‡‘èåˆ†ææ¨¡å‹
- **DeepSeek V3**: ä»£ç èƒ½åŠ›å¼ºï¼Œé€‚åˆå› å­ç¼–å†™å’ŒæŠ€æœ¯åˆ†æ
- **Claude 4.5**: æ€ç»´é“¾æ¨ç†ï¼Œé€‚åˆç­–ç•¥åˆ†æå’Œé£é™©è¯„ä¼°
- **Kimi K2-Thinking**: é•¿æ–‡æœ¬å¤„ç†ï¼Œé€‚åˆç ”æŠ¥å’Œè´¢æŠ¥åˆ†æ
- **Qwen 3**: ä¸­æ–‡ç†è§£ä¼˜ç§€ï¼Œé€‚åˆå¸‚åœºè§£è¯»å’Œæ–°é—»åˆ†æ

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨LLMç®¡ç†å™¨ï¼ˆæ¨èï¼‰

```python
from panda_common.llm_manager import get_llm_manager

# è·å–ç®¡ç†å™¨å®ä¾‹
llm = get_llm_manager()

# ä½¿ç”¨é»˜è®¤æ¨¡å‹ï¼ˆDeepSeek V3ï¼‰
response = llm.chat_completion(
    messages=[
        {"role": "user", "content": "å¸®æˆ‘åˆ†æè¿™ä¸ªå› å­çš„é€»è¾‘"}
    ]
)

# ä½¿ç”¨æŒ‡å®šæ¨¡å‹
response = llm.chat_completion(
    messages=[
        {"role": "user", "content": "åˆ†æè¿™ä»½è´¢æŠ¥"}
    ],
    model=llm.get_model('kimi')  # ä½¿ç”¨Kimiåˆ†æé•¿æ–‡æœ¬
)

# æŸ¥çœ‹ç®¡ç†å™¨çŠ¶æ€
status = llm.get_status()
print(f"å¯ç”¨å¯†é’¥: {status['total_keys']}")
print(f"è´Ÿè½½å‡è¡¡ç­–ç•¥: {status['strategy']}")
```

### æ–¹æ³•2: ç›´æ¥è°ƒç”¨ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰

```python
from panda_common.llm_manager import get_llm_manager

llm = get_llm_manager()

# æ ‡å‡†OpenAIæ ¼å¼è°ƒç”¨
response = llm.chat_completion(
    messages=[
        {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªé‡‘èåˆ†æä¸“å®¶"},
        {"role": "user", "content": "åˆ†æè¿™ä¸ªå› å­"}
    ],
    temperature=0.7,
    max_tokens=2000
)

content = response['choices'][0]['message']['content']
print(content)
```

---

## ğŸ§ª æµ‹è¯•å¤šå¯†é’¥ç³»ç»Ÿ

```powershell
py test_llm_multi_key.py
```

**æµ‹è¯•å†…å®¹**:
1. âœ… åˆå§‹åŒ–LLMç®¡ç†å™¨
2. âœ… æ˜¾ç¤ºå¯ç”¨æ¨¡å‹
3. âœ… æµ‹è¯•DeepSeek V3
4. âœ… æµ‹è¯•Kimi K2-Thinking
5. âœ… æŸ¥çœ‹å¯†é’¥çŠ¶æ€

**é¢„æœŸè¾“å‡º**:
```
======================================================================
æµ‹è¯•LLMå¤šå¯†é’¥è´Ÿè½½å‡è¡¡
======================================================================

[1/5] åˆå§‹åŒ–LLMç®¡ç†å™¨...
âœ… ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ
  APIå¯†é’¥æ•°é‡: 3
  è´Ÿè½½å‡è¡¡ç­–ç•¥: round_robin
  é»˜è®¤æ¨¡å‹: deepseek-ai/DeepSeek-V3

[2/5] å¯ç”¨çš„é‡‘èåˆ†ææ¨¡å‹:
  deepseek: deepseek-ai/DeepSeek-V3
  claude: anthropic/claude-3.5-sonnet
  kimi: Pro/moonshotai/Kimi-K2-Thinking
  qwen: Qwen/Qwen2.5-72B-Instruct

[3/5] æµ‹è¯•DeepSeek V3ï¼ˆä»£ç åˆ†æèƒ½åŠ›ï¼‰...
âœ… DeepSeek V3 å“åº”:
----------------------------------------------------------------------
DeepSeek V3åœ¨é‡‘èå› å­åˆ†æä¸­å…·æœ‰å¼ºå¤§çš„ä»£ç ç”Ÿæˆå’Œé€»è¾‘æ¨ç†èƒ½åŠ›...
----------------------------------------------------------------------
Tokenä½¿ç”¨: 45

[4/5] æµ‹è¯•Kimi K2-Thinkingï¼ˆé•¿æ–‡æœ¬æ¨ç†ï¼‰...
âœ… Kimi K2-Thinking å“åº”:
----------------------------------------------------------------------
Kimiæ“…é•¿å¤„ç†é•¿æ–‡æœ¬ï¼Œèƒ½å¤Ÿæ·±å…¥åˆ†æè´¢æŠ¥ã€ç ”æŠ¥ç­‰å¤æ‚æ–‡æ¡£...
----------------------------------------------------------------------
Tokenä½¿ç”¨: 52

[5/5] æŸ¥çœ‹APIå¯†é’¥çŠ¶æ€...
APIå¯†é’¥çŠ¶æ€:
  å¯†é’¥: sk-ljllswzyhlrrskmol...
    å¤±è´¥æ¬¡æ•°: 0
    æœ€åæˆåŠŸ: 2026-01-13 14:15:30
  å¯†é’¥: sk-ridvotghvcwjqormgu...
    å¤±è´¥æ¬¡æ•°: 0
    æœ€åæˆåŠŸ: 2026-01-13 14:15:32
  å¯†é’¥: sk-kefpbqtbxodjvubcvo...
    å¤±è´¥æ¬¡æ•°: 0
    æœ€åæˆåŠŸ: 2026-01-13 14:15:34

======================================================================
ğŸ‰ å¤šå¯†é’¥è´Ÿè½½å‡è¡¡æµ‹è¯•å®Œæˆï¼
======================================================================
```

---

## ğŸ’¡ é‡‘èåˆ†æåœºæ™¯

### åœºæ™¯1: å› å­ä»£ç ç”Ÿæˆï¼ˆDeepSeek V3ï¼‰

```python
llm = get_llm_manager()

response = llm.chat_completion(
    messages=[
        {"role": "user", "content": "å¸®æˆ‘å†™ä¸€ä¸ªRSIå› å­ï¼Œå‘¨æœŸ14å¤©"}
    ],
    model=llm.get_model('deepseek')
)
```

**ä¼˜åŠ¿**: ä»£ç ç”Ÿæˆèƒ½åŠ›å¼ºï¼ŒæŠ€æœ¯æŒ‡æ ‡å®ç°å‡†ç¡®

### åœºæ™¯2: è´¢æŠ¥åˆ†æï¼ˆKimi K2-Thinkingï¼‰

```python
llm = get_llm_manager()

response = llm.chat_completion(
    messages=[
        {"role": "user", "content": f"åˆ†æè¿™ä»½è´¢æŠ¥ï¼š{long_report_text}"}
    ],
    model=llm.get_model('kimi'),
    max_tokens=4000
)
```

**ä¼˜åŠ¿**: é•¿æ–‡æœ¬å¤„ç†èƒ½åŠ›å¼ºï¼Œèƒ½æ·±å…¥åˆ†æå¤æ‚æ–‡æ¡£

### åœºæ™¯3: ç­–ç•¥æ¨ç†ï¼ˆClaude 4.5ï¼‰

```python
llm = get_llm_manager()

response = llm.chat_completion(
    messages=[
        {"role": "user", "content": "åŸºäºè¿™äº›å› å­è®¾è®¡ä¸€ä¸ªé‡åŒ–ç­–ç•¥"}
    ],
    model=llm.get_model('claude')
)
```

**ä¼˜åŠ¿**: æ€ç»´é“¾æ¨ç†ï¼Œç­–ç•¥é€»è¾‘ä¸¥å¯†

### åœºæ™¯4: å¸‚åœºè§£è¯»ï¼ˆQwen 3ï¼‰

```python
llm = get_llm_manager()

response = llm.chat_completion(
    messages=[
        {"role": "user", "content": "è§£è¯»ä»Šå¤©çš„å¸‚åœºè¡Œæƒ…å’Œæ”¿ç­–å½±å“"}
    ],
    model=llm.get_model('qwen')
)
```

**ä¼˜åŠ¿**: ä¸­æ–‡ç†è§£ä¼˜ç§€ï¼Œå¸‚åœºè¯­å¢ƒæŠŠæ¡å‡†ç¡®

---

## ğŸ”„ è´Ÿè½½å‡è¡¡ç­–ç•¥

### è½®è¯¢ç­–ç•¥ï¼ˆå½“å‰ï¼‰

```yaml
LLM_LOAD_BALANCE_STRATEGY: "round_robin"
```

**å·¥ä½œæ–¹å¼**:
1. ç¬¬1æ¬¡è¯·æ±‚ â†’ ä½¿ç”¨å¡å¯†1
2. ç¬¬2æ¬¡è¯·æ±‚ â†’ ä½¿ç”¨å¡å¯†2
3. ç¬¬3æ¬¡è¯·æ±‚ â†’ ä½¿ç”¨å¡å¯†3
4. ç¬¬4æ¬¡è¯·æ±‚ â†’ ä½¿ç”¨å¡å¯†1ï¼ˆå¾ªç¯ï¼‰

**ä¼˜ç‚¹**: è´Ÿè½½å‡è¡¡ï¼Œæ‰€æœ‰å¯†é’¥ä½¿ç”¨å‡åŒ€

### éšæœºç­–ç•¥

```yaml
LLM_LOAD_BALANCE_STRATEGY: "random"
```

**å·¥ä½œæ–¹å¼**: æ¯æ¬¡éšæœºé€‰æ‹©ä¸€ä¸ªå¯†é’¥

**ä¼˜ç‚¹**: ç®€å•ï¼Œé€‚åˆæµ‹è¯•

### æ•…éšœè½¬ç§»ç­–ç•¥

```yaml
LLM_LOAD_BALANCE_STRATEGY: "failover"
```

**å·¥ä½œæ–¹å¼**: ä¼˜å…ˆä½¿ç”¨å¤±è´¥æ¬¡æ•°å°‘çš„å¯†é’¥

**ä¼˜ç‚¹**: è‡ªåŠ¨é¿å¼€æœ‰é—®é¢˜çš„å¯†é’¥

---

## ğŸ›¡ï¸ å®¹é”™æœºåˆ¶

### ä¸‰å±‚ä¿æŠ¤

1. **å¯†é’¥çº§é‡è¯•**: æ¯ä¸ªå¯†é’¥å¤±è´¥åé‡è¯•3æ¬¡
2. **å¯†é’¥åˆ‡æ¢**: å•ä¸ªå¯†é’¥æ‰€æœ‰é‡è¯•å¤±è´¥ååˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª
3. **å…¨å±€å¤±è´¥**: æ‰€æœ‰å¯†é’¥éƒ½å¤±è´¥æ‰æŠ›å‡ºå¼‚å¸¸

### ç¤ºä¾‹æµç¨‹

```
è¯·æ±‚ â†’ å¡å¯†1 (å°è¯•1) â†’ å¤±è´¥
     â†’ å¡å¯†1 (å°è¯•2) â†’ å¤±è´¥
     â†’ å¡å¯†1 (å°è¯•3) â†’ å¤±è´¥
     â†’ åˆ‡æ¢åˆ°å¡å¯†2 (å°è¯•1) â†’ æˆåŠŸ âœ…
```

---

## ğŸ“Š ç›‘æ§å’ŒçŠ¶æ€

### æŸ¥çœ‹å®æ—¶çŠ¶æ€

```python
from panda_common.llm_manager import get_llm_manager

llm = get_llm_manager()
status = llm.get_status()

print(f"æ€»å¯†é’¥æ•°: {status['total_keys']}")
print(f"è´Ÿè½½ç­–ç•¥: {status['strategy']}")

for key_status in status['key_status']:
    print(f"å¯†é’¥: {key_status['key']}")
    print(f"  å¤±è´¥æ¬¡æ•°: {key_status['failures']}")
    print(f"  æœ€åæˆåŠŸ: {key_status['last_success']}")
```

### æ—¥å¿—ç›‘æ§

LLMç®¡ç†å™¨ä¼šè®°å½•è¯¦ç»†æ—¥å¿—ï¼š
```
INFO: ä½¿ç”¨APIå¯†é’¥ sk-ljllswzyhlrrskmol... è°ƒç”¨æ¨¡å‹ deepseek-ai/DeepSeek-V3
INFO: APIè°ƒç”¨æˆåŠŸï¼Œä½¿ç”¨å¯†é’¥ sk-ljllswzyhlrrskmol...
WARNING: APIè°ƒç”¨å¤±è´¥ (å¯†é’¥ sk-ridvotghvcwjqormgu..., å°è¯• 1/3): Rate limit exceeded
INFO: ä½¿ç”¨APIå¯†é’¥ sk-kefpbqtbxodjvubcvo... è°ƒç”¨æ¨¡å‹ deepseek-ai/DeepSeek-V3
INFO: APIè°ƒç”¨æˆåŠŸï¼Œä½¿ç”¨å¯†é’¥ sk-kefpbqtbxodjvubcvo...
```

---

## ğŸ”§ é«˜çº§é…ç½®

### è°ƒæ•´é‡è¯•å‚æ•°

```yaml
LLM_MAX_RETRIES: 5        # å¢åŠ åˆ°5æ¬¡é‡è¯•
LLM_RETRY_DELAY: 2        # é‡è¯•é—´éš”2ç§’
```

### æ·»åŠ æ›´å¤šå¯†é’¥

```yaml
LLM_API_KEYS:
  - "sk-key1..."
  - "sk-key2..."
  - "sk-key3..."
  - "sk-key4..."  # æ·»åŠ ç¬¬4ä¸ªå¯†é’¥
  - "sk-key5..."  # æ·»åŠ ç¬¬5ä¸ªå¯†é’¥
```

### è‡ªå®šä¹‰æ¨¡å‹

```yaml
LLM_MODELS:
  deepseek: "deepseek-ai/DeepSeek-V3"
  custom_model: "your-custom-model-name"
```

---

## ğŸ’° ä½™é¢ç®¡ç†

### æŸ¥è¯¢ä½™é¢

è®¿é—®: https://siliconflow.ly-y.cn/

è¾“å…¥å„ä¸ªAPIå¯†é’¥æŸ¥è¯¢å‰©ä½™é¢åº¦ã€‚

### ä½™é¢ä¸è¶³å¤„ç†

å½“æŸä¸ªå¯†é’¥ä½™é¢ä¸è¶³æ—¶ï¼š
1. âœ… ç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å¯†é’¥
2. âœ… ä¸å½±å“æœåŠ¡æ­£å¸¸è¿è¡Œ
3. âœ… æ—¥å¿—è®°å½•åˆ‡æ¢ä¿¡æ¯

### è¡¥å……é¢åº¦

1. å……å€¼å½“å‰å¯†é’¥
2. æˆ–æ·»åŠ æ–°çš„å¯†é’¥åˆ°é…ç½®æ–‡ä»¶

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ¨¡å‹é€‰æ‹©å»ºè®®

| ä»»åŠ¡ç±»å‹ | æ¨èæ¨¡å‹ | åŸå›  |
|---------|---------|------|
| å› å­ä»£ç ç”Ÿæˆ | DeepSeek V3 | ä»£ç èƒ½åŠ›å¼º |
| è´¢æŠ¥åˆ†æ | Kimi K2 | é•¿æ–‡æœ¬å¤„ç† |
| ç­–ç•¥è®¾è®¡ | Claude 4.5 | æ·±åº¦æ¨ç† |
| å¸‚åœºè§£è¯» | Qwen 3 | ä¸­æ–‡ç†è§£ |

### 2. è´Ÿè½½å‡è¡¡å»ºè®®

- **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨ `round_robin` å‡è¡¡è´Ÿè½½
- **æµ‹è¯•ç¯å¢ƒ**: ä½¿ç”¨ `random` å¿«é€Ÿæµ‹è¯•
- **é«˜å¯ç”¨**: ä½¿ç”¨ `failover` è‡ªåŠ¨é¿éšœ

### 3. é‡è¯•é…ç½®å»ºè®®

- **å¿«é€Ÿå“åº”**: `MAX_RETRIES: 1`, `RETRY_DELAY: 0.5`
- **ç¨³å®šä¼˜å…ˆ**: `MAX_RETRIES: 5`, `RETRY_DELAY: 2`
- **å¹³è¡¡é…ç½®**: `MAX_RETRIES: 3`, `RETRY_DELAY: 1` (å½“å‰)

---

## âœ… é…ç½®å®Œæˆæ£€æŸ¥æ¸…å•

- [x] é…ç½®3ä¸ªAPIå¯†é’¥
- [x] é…ç½®4ç§é‡‘èåˆ†ææ¨¡å‹
- [x] è®¾ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥
- [x] é…ç½®é‡è¯•å‚æ•°
- [ ] è¿è¡Œæµ‹è¯•è„šæœ¬ `py test_llm_multi_key.py`
- [ ] é‡å¯æœåŠ¡åº”ç”¨é…ç½®
- [ ] éªŒè¯å¤šå¯†é’¥è½®è¯¢å·¥ä½œæ­£å¸¸

---

## ğŸš€ ä¸‹ä¸€æ­¥

```powershell
# 1. æµ‹è¯•å¤šå¯†é’¥ç³»ç»Ÿ
py test_llm_multi_key.py

# 2. é‡å¯æœåŠ¡
py start_server_fixed.py

# 3. å¼€å§‹ä½¿ç”¨LLMè¿›è¡Œé‡‘èåˆ†æ
```

**å¤šAPIå¯†é’¥è´Ÿè½½å‡è¡¡ç³»ç»Ÿå·²é…ç½®å®Œæˆï¼** ğŸ‰

ç°åœ¨æ‚¨æ‹¥æœ‰ï¼š
- âœ… 3ä¸ªAPIå¯†é’¥è‡ªåŠ¨è½®è¯¢
- âœ… 4ç§é‡‘èåˆ†ææ¨¡å‹
- âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»
- âœ… æ™ºèƒ½è´Ÿè½½å‡è¡¡
- âœ… å¼ºå¤§çš„é‡‘èåˆ†æèƒ½åŠ›
