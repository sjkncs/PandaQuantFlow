# 🐼 Panda AI 因子库 - 完整使用指南

## 🎯 新功能亮点

### ✨ 已集成的功能

1. **完整的Web界面** - 现代化的因子库管理界面
2. **多模型AI支持** - 4个AI模型可选（DeepSeek、Qwen等）
3. **智能代码生成** - AI自动生成因子代码
4. **端口管理工具** - 自动检查和清理端口占用
5. **MongoDB配置** - 可选的数据库支持
6. **一键启动** - 自动化的启动流程

---

## 🚀 快速开始（3步）

### 方法1: 一键启动（推荐）

双击运行：
```
启动因子库.bat
```

### 方法2: 命令行启动

```powershell
cd c:\Users\Lenovo\Desktop\PandaQuantFlow\panda_factor-main\panda_factor-main
py start_complete.py
```

### 方法3: 分步启动

```powershell
# 1. 检查端口
py port_manager.py

# 2. 配置MongoDB（可选）
py mongodb_setup.py

# 3. 启动服务
py start_complete.py
```

---

## 📊 访问界面

启动成功后，在浏览器中访问：

### 主要界面

- **因子库界面**: http://127.0.0.1:8111/factor/factor_library.html
- **API文档**: http://127.0.0.1:8111/docs
- **主页**: http://127.0.0.1:8111/

### 功能说明

#### 1. 因子库标签页 📊

- 查看可用因子
- 浏览因子分类
- 查看因子详情

#### 2. AI助手标签页 💬

- 与AI对话
- 询问量化问题
- 获取因子建议
- 支持4个模型切换：
  - DeepSeek V3 (代码生成)
  - Qwen 2.5 72B (市场分析)
  - Qwen Coder 32B (算法实现)
  - GLM-4 9B (通用对话)

#### 3. 代码生成标签页 ⚡

- 描述您需要的因子
- AI自动生成Python代码
- 一键复制或下载代码

#### 4. API文档标签页 📖

- 查看所有API端点
- 测试API调用
- 查看详细文档

---

## 🔧 工具说明

### 1. 端口管理工具 (port_manager.py)

**功能**:
- 检查端口占用情况
- 自动清理占用的端口
- 支持批量处理

**使用方法**:
```powershell
py port_manager.py
```

**选项**:
1. 自动清理所有占用的端口
2. 手动选择要清理的端口
3. 退出（不做任何操作）

### 2. MongoDB配置工具 (mongodb_setup.py)

**功能**:
- 检查MongoDB安装
- 启动MongoDB服务
- 创建数据库和集合
- 测试连接

**使用方法**:
```powershell
py mongodb_setup.py
```

**注意**:
- MongoDB是可选的
- 没有MongoDB也可以正常使用
- 数据会存储在内存中

### 3. 完整启动脚本 (start_complete.py)

**功能**:
- 自动检查依赖
- 自动检查端口
- 自动加载配置
- 启动所有服务

**使用方法**:
```powershell
py start_complete.py
```

---

## 🤖 AI模型配置

### 已配置的API密钥

配置文件位置: `panda_common/panda_common/config.yaml`

```yaml
LLM_API_KEYS:
  - "sk-ljllswzyhlrrskmolcxayvemftjuzrgbiuwnedfnfjckxnpu"
  - "sk-ridvotghvcwjqormgutcojreigmszrrqhijbezbwhbvhcedw"
  - "sk-kefpbqtbxodjvubcvoytodjsqtmaodriwtmreialxjbonstr"

LLM_MODEL: "deepseek-ai/DeepSeek-V3"
LLM_BASE_URL: "https://api.siliconflow.cn/v1"

LLM_MODELS:
  deepseek: "deepseek-ai/DeepSeek-V3"
  qwen: "Qwen/Qwen2.5-72B-Instruct"
  qwen_coder: "Qwen/Qwen2.5-Coder-32B-Instruct"
  glm: "THUDM/glm-4-9b-chat"
```

### 负载均衡策略

- **策略**: 轮询 (round_robin)
- **API密钥**: 3个并联
- **自动故障转移**: 是
- **重试次数**: 3次

---

## 💡 使用示例

### 示例1: 生成动量因子

1. 打开因子库界面
2. 切换到"代码生成"标签页
3. 输入描述：
   ```
   创建一个20日动量因子，使用收益率排名
   ```
4. 点击"生成代码"
5. 复制或下载生成的代码

### 示例2: AI对话咨询

1. 切换到"AI助手"标签页
2. 选择合适的模型（如Qwen用于市场分析）
3. 输入问题：
   ```
   如何评估一个因子的有效性？
   ```
4. 查看AI回复

### 示例3: 调用API

1. 打开API文档: http://127.0.0.1:8111/docs
2. 找到需要的端点
3. 点击"Try it out"
4. 输入参数
5. 执行请求

---

## ⚠️ 常见问题

### 问题1: 端口被占用

**错误**: `ERR_CONNECTION_REFUSED` 或 端口8111被占用

**解决方法**:
```powershell
py port_manager.py
```
选择自动清理端口

### 问题2: Web界面显示不完整

**原因**: 资源加载失败

**解决方法**:
1. 确保服务正在运行
2. 访问新界面: http://127.0.0.1:8111/factor/factor_library.html
3. 清除浏览器缓存
4. 使用Chrome或Edge浏览器

### 问题3: AI不响应

**可能原因**:
- API密钥失效
- 网络连接问题
- 服务未启动

**解决方法**:
1. 检查服务状态
2. 查看终端输出
3. 测试API连接
4. 检查config.yaml配置

### 问题4: MongoDB连接失败

**提示**: MongoDB是可选的

**解决方法**:
1. 不使用MongoDB继续运行
2. 或运行配置工具:
   ```powershell
   py mongodb_setup.py
   ```

### 问题5: 依赖缺失

**错误**: `ModuleNotFoundError`

**解决方法**:
```powershell
pip install fastapi uvicorn pydantic pymongo
```

或运行启动脚本会自动安装

---

## 📁 文件结构

```
panda_factor-main/
├── 启动因子库.bat              # 一键启动脚本
├── start_complete.py           # 完整启动脚本
├── port_manager.py             # 端口管理工具
├── mongodb_setup.py            # MongoDB配置工具
├── 如何启动服务.md             # 基础启动指南
├── 完整使用指南.md             # 本文件
│
├── panda_web/
│   └── panda_web/
│       └── static/
│           ├── factor_library.html  # 新的因子库界面
│           └── index.html           # 原始界面
│
├── panda_common/
│   └── panda_common/
│       └── config.yaml         # 配置文件（包含API密钥）
│
└── panda_llm/
    └── routes/
        └── chat_router.py      # LLM路由
```

---

## 🎨 界面特性

### 现代化设计

- ✅ 渐变色背景
- ✅ 卡片式布局
- ✅ 流畅动画效果
- ✅ 响应式设计
- ✅ 深色代码编辑器

### 交互功能

- ✅ 实时AI对话
- ✅ 代码一键复制
- ✅ 模型切换
- ✅ API状态监控

---

## 🔐 安全说明

### API密钥管理

- 密钥存储在 `config.yaml`
- 不要将配置文件上传到公共仓库
- 定期更换API密钥
- 使用环境变量（可选）

### 网络安全

- 默认只监听本地 (127.0.0.1)
- 生产环境需要配置HTTPS
- 建议使用防火墙

---

## 📈 性能优化

### 建议配置

- **内存**: 至少4GB
- **CPU**: 2核心以上
- **网络**: 稳定的互联网连接

### 优化建议

1. 使用MongoDB存储数据（可选）
2. 配置多个API密钥
3. 启用负载均衡
4. 定期清理日志

---

## 🆘 获取帮助

### 查看日志

日志位置: `logs/`

### 检查服务状态

```powershell
py check_service.py
```

### 测试API

访问: http://127.0.0.1:8111/docs

### 查看配置

```powershell
type panda_common\panda_common\config.yaml
```

---

## 🎉 总结

### 您现在拥有

1. ✅ 完整的Web界面
2. ✅ 4个AI模型支持
3. ✅ 智能代码生成
4. ✅ 端口管理工具
5. ✅ MongoDB配置（可选）
6. ✅ 一键启动脚本

### 下一步

1. 双击 `启动因子库.bat`
2. 访问 http://127.0.0.1:8111/factor/factor_library.html
3. 开始使用AI生成因子！

---

## 📞 联系方式

- 查看文档: `START_HERE.md`
- API文档: http://127.0.0.1:8111/docs
- 配置指南: `如何启动服务.md`

---

**最后更新**: 2026-01-14

**版本**: 2.0.0

🎊 祝您使用愉快！
